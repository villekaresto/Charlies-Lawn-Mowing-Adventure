<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=yes" />
<title>Charlie's Lawn Mowing Adventure ‚Äì The Game</title>
<meta name="description" content="Help Charlie mow lawns in this mobile-friendly comedy game. 12 levels, power ups, obstacles, and a local leaderboard." />
<style>
  :root{
    --bg1:#1e293b; --bg2:#3b82f6; --bg3:#9333ea; --sky:#f472b6;
    --brand:#1e293b; --accent:#3b82f6; --accent2:#60a5fa; --accent-dark:#1e40af;
    --card:rgba(255,255,255,.95); --glass:rgba(255,255,255,.85);
    --sat:env(safe-area-inset-top); --sar:env(safe-area-inset-right);
    --sab:env(safe-area-inset-bottom); --sal:env(safe-area-inset-left);
  }
  html,body{height:100%;margin:0;padding:0;overflow:hidden}
  *{
    box-sizing:border-box;
    user-select:none; -webkit-user-select:none;
    -webkit-touch-callout:none;
    -webkit-tap-highlight-color:transparent;
  }
  input, textarea{user-select:text; -webkit-user-select:text;}
  body{
    margin:0;background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 20%,var(--bg3) 60%,var(--sky) 100%);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,sans-serif;color:var(--brand);
    display:flex;align-items:center;justify-content:center;padding:16px;
    touch-action:manipulation;
  }
  body::before{content:"";position:fixed;inset:0;pointer-events:none;z-index:-1;
    background:
      radial-gradient(circle at 20% 80%,rgba(255,255,255,.12),transparent 50%),
      radial-gradient(circle at 80% 20%,rgba(255,255,255,.06),transparent 50%);
  }
  .screen{
    width:min(920px,95vw);min-height:min(86vh,960px);background:var(--card);
    border:2px solid rgba(255,255,255,.35);border-radius:22px;padding:20px;
    box-shadow:0 10px 40px rgba(0,0,0,.28);display:flex;flex-direction:column;gap:12px;
    max-height:100vh;overflow-y:auto;
  }
  body.playing{padding:0}
  body.playing .screen{width:100vw;height:100vh;border:none;border-radius:0}
  h1{margin:0;text-align:center;font-weight:900;font-size:1.9rem;
     background:linear-gradient(135deg,var(--brand),var(--accent),var(--sky));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
  h1::after{content:"üè° WW Neighborhood";display:block;color:#667;font-size:.9rem;margin-top:4px;font-weight:600;opacity:.85}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center}
  .card{background:var(--glass);border:2px solid rgba(255,255,255,.45);border-radius:16px;padding:14px}
  .hud{display:flex;gap:10px;justify-content:space-between;flex-wrap:wrap;background:var(--glass);border-radius:12px;border:2px solid rgba(255,255,255,.4);padding:8px 12px;font-weight:800}
  .hud > div{min-width:120px;text-align:center}
  .level-title{display:inline-block;background:linear-gradient(135deg,rgba(255,215,0,.98),rgba(255,140,0,.95));
    border:3px solid rgba(255,215,0,.9);color:#222;padding:8px 16px;border-radius:18px;box-shadow:0 4px 18px rgba(255,215,0,.45);font-weight:900}
  .desc{font-size:.95rem;background:rgba(240,248,255,.92);border:2px solid rgba(173,216,230,.35);border-radius:10px;padding:8px}

  #gameCanvas{
    display:block;margin:0 auto;border-radius:10px;border:3px solid var(--accent);background:#7CFC00;
    touch-action:none; -ms-touch-action:none;
    -webkit-user-select:none; user-select:none; -webkit-touch-callout:none;
    -webkit-tap-highlight-color:transparent;
    cursor:crosshair;
  }

  .progress{background:rgba(255,255,255,.9);border:2px solid rgba(255,255,255,.5);border-radius:12px;overflow:hidden}
  .bar{height:24px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;font-weight:900;text-align:center;line-height:24px;transition:width .25s}

  .controls-wrap{display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(2,1fr);gap:10px;justify-items:center;align-items:center;
    touch-action:none; -ms-touch-action:none;
    margin-bottom:10px;
  }

  @media (pointer:coarse){
    .controls-wrap{margin-bottom:calc(10px + env(safe-area-inset-bottom,0) + 8vh);}
  }
  .pad-btn{
    width:84px;height:84px;max-width:28vw;max-height:28vw;border-radius:16px;border:2px solid #cfcfcf;
    background:linear-gradient(135deg,#f4f4f4,#dadada);font-size:1.6rem;font-weight:900;box-shadow:0 4px 10px rgba(0,0,0,.1);
    -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent;
    touch-action:none;cursor:pointer;
  }
  .pad-btn:active,.pad-btn.active{background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:#fff;transform:scale(.97)}
  .pad-up{grid-column:2;grid-row:1} .pad-left{grid-column:1;grid-row:2}
  .pad-right{grid-column:3;grid-row:2} .pad-down{grid-column:2;grid-row:2}

  .btn{cursor:pointer;border:none;font-weight:900;border-radius:10px;padding:10px 16px}
  .btn-primary{background:linear-gradient(135deg,var(--brand),var(--accent));color:#fff}
  .btn-green{background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:#fff}
  .btn-blue{background:linear-gradient(135deg,#2196F3,#1976D2);color:#fff}
  .comment{background:rgba(255,248,220,.95);border:2px solid rgba(255,215,0,.35);border-radius:10px;padding:8px;font-style:italic}

  @keyframes fade-in{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}
  @keyframes fade-out{from{opacity:1;transform:scale(1)}to{opacity:0;transform:scale(.98)}}
  .overlay{display:none;position:fixed;inset:0;background:rgba(255,255,255,.96);backdrop-filter:blur(10px);z-index:20;
           border:2px solid rgba(255,255,255,.35);border-radius:16px;max-width:min(480px,90vw);max-height:90vh;margin:auto;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.32);
           opacity:0;transform:scale(.98);overflow-y:auto}
  .overlay.show{display:block;will-change:transform,opacity;animation:fade-in 200ms forwards}
  .overlay.hide{will-change:transform,opacity;animation:fade-out 200ms forwards}
  .overlay.crash{background:rgba(255,235,238,.96);border-color:rgba(244,67,54,.35)}
  .overlay.crash h2{color:#c62828}
  .overlay.complete{background:rgba(232,245,233,.96);border-color:rgba(76,175,80,.35)}
  .leader-filters{display:flex;gap:8px;justify-content:center;margin-bottom:8px}
  .filter{background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:#fff;border:none;border-radius:9px;padding:8px 12px;font-weight:800;cursor:pointer}
  .filter.active{background:linear-gradient(135deg,var(--brand),var(--accent))}
  .power-slots{display:flex;gap:10px;justify-content:center}
  .slot{background:#fff;border:2px solid rgba(0,0,0,.08);border-radius:10px;padding:6px 10px;font-weight:900;display:flex;align-items:center;gap:4px}
  .power-slots .icon{width:1.2em;height:1.2em}
  .timers{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
  .mute{font-size:1.4rem;background:none;border:none;cursor:pointer}

  #toast{position:fixed;left:50%;top:16px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:12px;font-weight:900;letter-spacing:.3px;opacity:0;pointer-events:none;transition:opacity .2s, transform .2s; z-index:99}
  #toast.show{opacity:1;transform:translateX(-50%) scale(1.02)}

  @media (max-width:520px){
    .pad-btn{width:70px;height:70px;font-size:1.4rem}
    h1{font-size:1.5rem}
  }
</style>
</head>
<body tabindex="0">

<div class="screen" id="app">
  <h1>üöú Charlie's Lawn Mowing Adventure ‚Äì The Game</h1>

  <!-- Landing -->
  <div class="card row" id="landing">
    <div class="card">
        <div style="text-align:center;font-weight:800;margin-bottom:6px">Enter Your Name</div>
        <form id="startForm" style="margin:0">
          <input id="playerName" type="text" maxlength="15" placeholder="Your Name" required style="padding:10px 12px;border-radius:10px;border:2px solid var(--accent);font-weight:700;text-align:center;min-width:min(260px,80vw);margin-bottom:10px" />
          <div class="row" style="margin:10px 0">
            <button id="startGameBtn" class="btn btn-primary" type="submit">Start Mowing!</button>
          </div>
        </form>
        <div class="desc" style="margin-top:8px">
        Cainhoy breeze in his hair, bare feet on the turf, Bud on ice, and a borrowed EGO he swears he hates but actually loves. Ladies' man energy, HOA precision.
      </div>
    </div>
    <div class="card" style="min-width:min(320px,90vw)">
      <div style="font-weight:900;margin-bottom:6px">üèÜ Top Champions</div>
      <div id="leaderboardPreview">Be the first champion! üå±</div>
    </div>
    <div class="row">
      <button id="challengeBtn" class="btn btn-green">üéØ Challenge a Friend</button>
      <button id="shareGameBtn" class="btn btn-green">üì± Share Game</button>
    </div>
  </div>

  <!-- Game -->
  <div id="game" style="display:none">
    <div class="hud">
      <div>üë§ Player: <span id="hudName"></span></div>
      <div>üèÅ Level: <span id="hudLevel">1</span>/12</div>
      <div>üíØ Score: <span id="hudScore">0</span></div>
      <div>üèÜ Best: <span id="hudBest">0</span></div>
    </div>

    <div class="row">
      <div class="level-title" id="levelName">Charlie's Front Yard</div>
    </div>
    <div class="desc" id="levelDesc">Welcome to Cainhoy. Mind the flamingo, the Dodge RAM, and that Bud cooler in the shade.</div>

    <div class="timers">
      <div>Total: <span id="timer">0:00</span></div>
      <div>Level: <span id="levelTimer">0:00</span></div>
      <div id="weatherEl">‚òÄÔ∏è Perfect</div>
      <div>Left: <span id="countdown">0:00</span></div>
    </div>

    <div class="progress"><div id="bar" class="bar" style="width:0%">üåø 0% Mowed</div></div>

    <div class="comment" id="comment" aria-live="polite">Welcome to the championship. Time to edge like the HOA is watching.</div>

    <canvas id="gameCanvas" width="400" height="300" aria-label="Game field" role="img"></canvas>

    <div class="power-slots">
      <div class="slot">
        <span class="icon">üç∫</span><span id="budCount">0</span>
      </div>
      <div class="slot">
        <span class="icon">üöó</span><span id="golfCount">0</span>
      </div>
      <div class="slot">
        <span class="icon">üçÉ</span><span id="leafCount">0</span>
      </div>
    </div>

    <div class="row">
      <button id="startLevelBtn" class="btn btn-green">Start Level 1</button>
      <button id="pauseBtn" class="btn btn-green" disabled>Pause</button>
      <button id="shareShot" class="btn btn-blue" style="display:none">üì∏ Share Victory</button>
      <button id="soundBtn" class="mute" aria-pressed="true" title="Toggle sound">üîä</button>
    </div>

    <!-- On-screen d-pad -->
    <div class="controls-wrap" id="pad" aria-hidden="false" style="margin-top:6px">
      <button id="padUp" class="pad-btn pad-up" aria-label="Move up">‚ñ≤</button>
      <button id="padLeft" class="pad-btn pad-left" aria-label="Move left">‚óÑ</button>
      <button id="padRight" class="pad-btn pad-right" aria-label="Move right">‚ñ∫</button>
      <button id="padDown" class="pad-btn pad-down" aria-label="Move down">‚ñº</button>
    </div>
  </div>
</div>

<!-- Overlays -->
<div class="overlay complete" id="ovComplete">
  <h2>Level Complete! üéâ</h2>
  <p id="ovCongrats" style="font-weight:700"></p>
  <p>Time: <span id="ovTime">0:00</span></p>
  <p>Score: <span id="ovScore">0</span></p>
  <p>Time Bonus: <span id="ovBonus">0</span></p>
  <div class="row"><button id="nextLevel" class="btn btn-primary">Next Level</button></div>
</div>

<div class="overlay" id="ovGameOver">
  <h2 id="ovGameOverTitle">Time's Up! ‚è∞</h2>
  <p id="ovGameOverBody"><span id="ovReason">You ran out of time on</span> Level <span id="ovFailed">1</span></p>
  <p>Final Score: <span id="ovFinalScore">0</span></p>
  <div class="row"><button id="restart" class="btn btn-primary">Try Again</button><button id="showLB" class="btn btn-green">View Leaderboard</button></div>
</div>

<div class="overlay" id="ovFinalOverlay">
  <h2>üèÜ Championship Complete! üèÜ</h2>
  <p><strong><span id="ovWinner"></span></strong> - Master Mower!</p>
  <p>Total Time: <span id="ovTotal">0:00</span></p>
  <p>Final Score: <span id="ovChamp">0</span></p>
  <div class="row"><button id="again" class="btn btn-primary">Play Again</button><button id="goLB" class="btn btn-green">View Leaderboard</button></div>
</div>

<div class="overlay" id="ovLB">
  <h2>üèÜ WW Champions</h2>
  <div class="leader-filters">
    <button class="filter active" id="fAll">All Time</button>
    <button class="filter" id="fWeek">This Week</button>
    <button class="filter" id="fYou">Your Runs</button>
  </div>
  <div id="lbList"></div>
  <div class="row"><button id="lbBack" class="btn btn-primary">Back</button></div>
</div>

<div class="overlay" id="ovPause">
  <h2>‚è∏ Paused</h2>
  <p>Press P or Space or tap Resume.</p>
  <div class="row"><button id="resume" class="btn btn-primary">Resume</button></div>
</div>

<div class="overlay" id="ovIntro">
  <h2 id="introTitle">Level Intro</h2>
  <p id="introDesc" class="desc" style="margin-top:0"></p>
  <p id="introBody" style="font-size:1.02rem"></p>
  <div class="row"><button id="introGo" class="btn btn-primary">Start Level</button></div>
</div>

<div class="overlay" id="ovChallenge">
  <h3>üéØ Challenge a Friend!</h3>
  <p>Share this message:</p>
  <textarea id="chText" readonly style="width:min(90%,320px);height:120px;padding:8px"></textarea>
  <div class="row"><button id="copyCh" class="btn btn-primary">üìã Copy</button><button id="closeCh" class="btn btn-green">Close</button></div>
</div>

<div id="toast" role="status" aria-live="polite"></div>

<script>
/* -------------------- Data -------------------- */
const levels=[
{n:"Barefoot Boulevard",d:"Toes out, dew cold, bottle caps everywhere.",palette:{grassColor:"#7CFC00",mowedColor:"#90EE90",skyColor:"#87CEEB"}},
{n:"RAM Yard Test Track",d:"The Dodge RAM is blocking your line. Work around it.",palette:{grassColor:"#7CFC00",mowedColor:"#90EE90",skyColor:"#87CEEB"}},
{n:"Golf Cart Grand Prix",d:"Shortcuts allowed. Avoid the welcome mat pothole.",palette:{grassColor:"#7CFC00",mowedColor:"#90EE90",skyColor:"#87CEEB"}},
{n:"Trampoline Tangle",d:"Orbit the trampoline legs. No flips, all stripes.",palette:{grassColor:"#7CFC00",mowedColor:"#90EE90",skyColor:"#87CEEB"}},
{n:"Edging Invitational",d:"Driveway, beds, sidewalk. Sharp lines only.",palette:{grassColor:"#C2B280",mowedColor:"#DEB887",skyColor:"#FFDAB9"}},
{n:"Blower Showdown",d:"Blast corners clean. Leave no crumb behind.",palette:{grassColor:"#C2B280",mowedColor:"#DEB887",skyColor:"#FFDAB9"}},
{n:"EGO vs Husky Derby",d:"Talks smack about electric, borrows EGO anyway.",palette:{grassColor:"#C2B280",mowedColor:"#DEB887",skyColor:"#FFDAB9"}},
{n:"Budweiser Yard Party",d:"Mow around the coolers. Cans are not power ups.",palette:{grassColor:"#C2B280",mowedColor:"#DEB887",skyColor:"#FFDAB9"}},
{n:"Cainhoy Dollar Tree HOA Finals",d:"Every neighbor is judging the stripes.",palette:{grassColor:"#E0F8FF",mowedColor:"#F8FFF8",skyColor:"#B0E0E6"}},
{n:"Lowcountry Crosswind",d:"Cainhoy gusts push your deck. Hold the line.",palette:{grassColor:"#E0F8FF",mowedColor:"#F8FFF8",skyColor:"#B0E0E6"}},
{n:"Overtime Overgrowth",d:"Bonus jungle. The clippings will tell your story.",palette:{grassColor:"#E0F8FF",mowedColor:"#F8FFF8",skyColor:"#B0E0E6"}},
{n:"Golden Grass Champion",d:"Perfect pass, perfect blow, perfect edge.",palette:{grassColor:"#E0F8FF",mowedColor:"#F8FFF8",skyColor:"#B0E0E6"}}
];

const introsByLevel=[
  ["Charlie kicks off his sandals and tells the lawn behave. The lawn refuses. You accept."],
  ["The RAM is parked like a shrine. Mow around it without carving a logo."],
  ["Golf cart is NASCAR ready. Keep straighter lines than your weekend alibi."],
  ["Orbit the trampoline legs. Touch one and kids boo in surround sound."],
  ["Edge so crisp it slices gossip. The HOA writes poetry."],
  ["Time to blow. The leaves, obviously. Mind out of gutter."],
  ["Husqvarna shirt, EGO in hand. It is a safe space for contradictions."],
  ["Bud pyramid by the porch. Hydrate with your eyes only."],
  ["Smile and wave. The HOA is timing your turns."],
  ["Lowcountry wind steals hats and secrets. Keep both."],
  ["The yard grew like it had a coupon. Time to void it."],
  ["Final lap. The lawn wants a photo finish."]
];

const congratsByLevel=[
  ["{n}, Mr. Dickson saluted with her garden glove. That never happens."],
  ["{n}, the RAM's reflection on those lines is illegal in three counties."],
  ["{n}, the golf cart asked for your autograph. Twice."],
  ["{n}, even the trampoline stopped squeaking to admire you."],
  ["{n}, the edger winked. The sidewalk took notes."],
  ["{n}, that blower finale had neighbors clapping like fireworks."],
  ["{n}, Husqvarna and EGO both claim you now. Peace talks scheduled."],
  ["{n}, Bud pyramid remains untouched. That is self control."],
  ["{n}, the HOA framed your pattern by the pool."],
  ["{n}, Cainhoy winds took a day off out of respect."],
  ["{n}, the jungle cried uncle and paid taxes."],
  ["{n}, crown secured. The lawn genuflected."]
];

/* -------------------- State -------------------- */
let gameState = {
  running: false,
  paused: false,
  lvl: 1,
  score: 0,
  total: 0,
  lvlStart: 0,
  name: "",
  loop: null,
  last: 0,
  introShown: false,
  limit: 60,
  timers: {
    bud: null,
    budBoost: null,
    golfInv: null,
    comment: null,
    toast: null
  }
};

let mower = {x:50,y:50,w:16,h:16,spd:120,vx:0,vy:0,boost:false,inv:false};
let tiles = [];
let powerUps = [];
let obs = [];
let particles = [];
let weather = {type:"sun",t:0};
let counts = {bud:0,golf:0,leaf:0};
let keys = {};
let inputState = {active:false,startX:0,startY:0,id:null};

/* -------------------- Canvas Setup -------------------- */
const cvs = document.getElementById('gameCanvas');
const ctx = cvs.getContext('2d', {alpha:false});
const BASE_W = 400, BASE_H = 300;
let pal = null;

function fitCanvas() {
  const dpr = Math.min(window.devicePixelRatio || 1, 2);
  const vv = window.visualViewport || {width: window.innerWidth, height: window.innerHeight};
  const styles = getComputedStyle(document.documentElement);
  const insetTop = parseFloat(styles.getPropertyValue('--sat')) || 0;
  const insetRight = parseFloat(styles.getPropertyValue('--sar')) || 0;
  const insetBottom = parseFloat(styles.getPropertyValue('--sab')) || 0;
  const insetLeft = parseFloat(styles.getPropertyValue('--sal')) || 0;

  const availableWidth = vv.width - insetLeft - insetRight;
  const availableHeight = vv.height - insetTop - insetBottom;
  const scale = Math.min(availableWidth / BASE_W, availableHeight / BASE_H);
  const cssW = BASE_W * scale;
  const cssH = BASE_H * scale;

  cvs.style.width = cssW + 'px';
  cvs.style.height = cssH + 'px';
  cvs.width = BASE_W * dpr;
  cvs.height = BASE_H * dpr;
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

  const hud = document.querySelector('.hud');
  const pad = document.getElementById('pad');
  if(hud) hud.style.width = cssW + 'px';
  if(pad){
    pad.style.width = cssW + 'px';
    pad.style.marginLeft = 'auto';
    pad.style.marginRight = 'auto';
  }

  if(gameState.running) draw();
}

/* -------------------- Utils -------------------- */
const ri = (a,b) => Math.floor(Math.random()*(b-a+1))+a;
const rc = a => a[Math.floor(Math.random()*a.length)];
const fmt = s => {const m=Math.floor(s/60),sec=Math.floor(s%60);return `${m}:${sec<10?"0":""}${sec}`};
const hit = (a,b) => !(a.x+a.w<b.x||a.x>b.x+b.w||a.y+a.h<b.y||a.y>b.y+b.h);

/* -------------------- Cleanup -------------------- */
function cleanupTimers() {
  Object.values(gameState.timers).forEach(t => {
    if(t) clearTimeout(t);
  });
  gameState.timers = {bud:null,budBoost:null,golfInv:null,comment:null,toast:null};
}

function resetInputState() {
  keys = {};
  inputState = {active:false,startX:0,startY:0,id:null};
  document.querySelectorAll('.pad-btn').forEach(btn => btn.classList.remove('active'));
}

/* -------------------- Input Handling -------------------- */
document.addEventListener('keydown', e => {
  const k = e.key;
  if(['arrowup','arrowdown','arrowleft','arrowright','w','a','s','d',' ','p'].includes(k.toLowerCase())) {
    e.preventDefault();
    keys[k.toLowerCase()] = true;
    if((k.toLowerCase() === 'p' || k === ' ') && gameState.running) togglePause();
  }
});

document.addEventListener('keyup', e => {
  keys[e.key.toLowerCase()] = false;
});

// D-pad buttons
const padButtons = [
  {id:'padUp',key:'arrowup'},
  {id:'padDown',key:'arrowdown'},
  {id:'padLeft',key:'arrowleft'},
  {id:'padRight',key:'arrowright'}
];

padButtons.forEach(({id,key}) => {
  const btn = document.getElementById(id);
  if(!btn) return;
  
  const activate = () => {
    keys[key] = true;
    btn.classList.add('active');
  };
  
  const deactivate = () => {
    keys[key] = false;
    btn.classList.remove('active');
  };
  
  const onPointerDown = e => {
    if(e.pointerType === 'mouse' && e.button !== 0) return;
    e.preventDefault();
    activate();
  };

  const onPointerUp = () => deactivate();

  btn.addEventListener('pointerdown', onPointerDown);
  btn.addEventListener('pointermove', e => {
    if(!e.isPrimary) return;
    // Prevent scrolling when dragging on touch devices
    if(e.pointerType !== 'mouse') e.preventDefault();
  });
  ['pointerup','pointercancel','pointerleave','pointerout'].forEach(event => {
    btn.addEventListener(event, onPointerUp);
  });
});

// Canvas touch/mouse/stylus controls
const DEAD_ZONE = 20;

function handleCanvasInput(clientX, clientY, isStart) {
  if(isStart) {
    inputState.active = true;
    inputState.startX = clientX;
    inputState.startY = clientY;
  } else if(inputState.active) {
    const dx = clientX - inputState.startX;
    const dy = clientY - inputState.startY;
    const ax = Math.abs(dx);
    const ay = Math.abs(dy);
    
    keys.arrowup = ay > DEAD_ZONE && dy < 0;
    keys.arrowdown = ay > DEAD_ZONE && dy > 0;
    keys.arrowleft = ax > DEAD_ZONE && dx < 0;
    keys.arrowright = ax > DEAD_ZONE && dx > 0;
  }
}

cvs.addEventListener('pointerdown', e => {
  if(e.pointerType === 'mouse' && e.button !== 0) return;
  e.preventDefault();
  handleCanvasInput(e.clientX, e.clientY, true);
});

cvs.addEventListener('pointermove', e => {
  if(!inputState.active) return;
  if(e.pointerType === 'mouse' && e.buttons !== 1) return;
  e.preventDefault();
  handleCanvasInput(e.clientX, e.clientY, false);
});

['pointerup','pointercancel','pointerleave','pointerout'].forEach(event => {
  cvs.addEventListener(event, e => {
    if(e.pointerType === 'mouse' && e.button !== 0) return;
    inputState.active = false;
    keys.arrowup = keys.arrowdown = keys.arrowleft = keys.arrowright = false;
  });
});

/* -------------------- Audio -------------------- */
let snd = true;
let actx = null;

function initAudio() {
  if(!actx) {
    try {
      actx = new (window.AudioContext || window.webkitAudioContext)();
      if(actx.state === 'suspended') {
        actx.resume();
      }
    } catch(e) {
      console.log('Audio not available');
    }
  }
}

function beep(f=880,d=.05,v=.15) {
  if(!snd || !actx) return;
  try {
    const o = actx.createOscillator();
    const g = actx.createGain();
    o.type = 'square';
    o.frequency.value = f;
    g.gain.value = v;
    o.connect(g).connect(actx.destination);
    o.start();
    o.stop(actx.currentTime + d);
  } catch(e) {}
}

function chime() {
  beep(660,.07,.18);
  setTimeout(() => beep(990,.07,.18), 65);
}

/* -------------------- Toast -------------------- */
function showToast(msg, ms=1800) {
  const toastEl = document.getElementById('toast');
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  clearTimeout(gameState.timers.toast);
  gameState.timers.toast = setTimeout(() => toastEl.classList.remove('show'), ms);
}

/* -------------------- Game Loop -------------------- */
function frame(ts) {
  if(!gameState.running || gameState.paused) return;
  
  const dt = Math.min((ts - gameState.last) / 1000, .1);
  gameState.last = ts;
  
  step(dt);
  draw();
  gameState.loop = requestAnimationFrame(frame);
}

function step(dt) {
  handleInput(dt);
  moveMower(dt);
  checkTiles();
  checkPowerUps();
  checkCollisions();
  updateParticles(dt);
  updateWeather(dt);
  gameState.total += dt;
  updateUI();
  checkWin();
  checkTime();
}

function handleInput(dt) {
  let tx = 0, ty = 0;
  if(keys.arrowup || keys.w) ty = -mower.spd;
  if(keys.arrowdown || keys.s) ty = mower.spd;
  if(keys.arrowleft || keys.a) tx = -mower.spd;
  if(keys.arrowright || keys.d) tx = mower.spd;
  
  const acc = 8;
  mower.vx += (tx - mower.vx) * acc * dt;
  mower.vy += (ty - mower.vy) * acc * dt;
  
  if(Math.abs(tx) < 1) mower.vx *= 0.9;
  if(Math.abs(ty) < 1) mower.vy *= 0.9;
}

function moveMower(dt) {
  let fx = 1;
  if(weather.type === 'rain') fx = 0.9;
  if(weather.type === 'wind') mower.x += Math.sin(Date.now()/330) * 8 * dt;
  
  mower.x += mower.vx * dt * fx;
  mower.y += mower.vy * dt * fx;
  mower.x = Math.max(0, Math.min(BASE_W - mower.w, mower.x));
  mower.y = Math.max(0, Math.min(BASE_H - mower.h, mower.y));
}

function checkTiles() {
  for(const t of tiles) {
    if(!t.m && hit(mower, t)) {
      t.m = true;
      gameState.score += 10;
      if((t.x + t.y) % 40 === 0) beep(520, .02, .08);
    }
  }
}

function checkPowerUps() {
  for(const p of powerUps) {
    if(p.a && hit(mower, p)) {
      p.a = false;
      applyPowerUp(p.t);
    }
  }
}

function checkCollisions() {
  if(mower.inv) return;
  
  for(const o of obs) {
    if(o.a && hit(mower, o)) {
      o.a = false;
      mower.vx = mower.vy = 0;
      setComment(`Easy there. Go around the ${o.t}.`);
      gameOver('obstacle');
      return;
    }
  }
}

function updateParticles(dt) {
  if(Math.abs(mower.vx) > 10 || Math.abs(mower.vy) > 10) {
    if(Math.random() < 0.3) {
      particles.push({
        x: mower.x + mower.w/2,
        y: mower.y + mower.h/2,
        dx: (Math.random() - 0.5) * 20,
        dy: (Math.random() - 0.5) * 20,
        life: 1
      });
    }
  }
  
  for(let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.dx * dt;
    p.y += p.dy * dt;
    p.life -= dt * 2;
    if(p.life <= 0) particles.splice(i, 1);
  }
  
  if(particles.length > 50) particles.length = 50;
}

function updateWeather(dt) {
  weather.t -= dt;
  if(weather.t <= 0) {
    weather.type = rc(['sun','rain','wind']);
    weather.t = ri(12, 22);
    updateWeatherDisplay();
  }
}

function checkWin() {
  const mowed = tiles.filter(t => t.m).length;
  const total = tiles.length;
  const prog = Math.floor((mowed / Math.max(1, total)) * 100);
  
  const bar = document.getElementById('bar');
  bar.style.width = prog + "%";
  bar.textContent = `${prog}% Mowed üåø`;
  
  if(mowed === total && total > 0) levelComplete();
}

function checkTime() {
  const elapsed = gameState.total - gameState.lvlStart;
  const left = Math.max(0, gameState.limit - elapsed);
  document.getElementById('countdown').textContent = fmt(left);
  
  if(left <= 10 && Math.floor(left * 10) % 5 === 0) beep(900, .02, .06);
  if(elapsed >= gameState.limit) gameOver('time');
}

/* -------------------- World Generation -------------------- */
function spawnBud() {
  for(let tries = 0; tries < 20; tries++) {
    const p = {
      t: 'bud',
      x: ri(20, BASE_W - 44),
      y: ri(20, BASE_H - 44),
      w: 24,
      h: 24,
      a: true,
      tt: 18
    };
    
    const safe = !obs.some(o => o.a && hit(p, o));
    if(safe) {
      powerUps.push(p);
      return;
    }
  }
}

function setup(level) {
  cleanupTimers();
  resetInputState();
  
  tiles = [];
  powerUps = [];
  obs = [];
  particles = [];
  mower = {x:50,y:50,w:16,h:16,spd:120,vx:0,vy:0,boost:false,inv:false};
  gameState.introShown = false;
  
  const lvlData = levels[Math.min(level - 1, levels.length - 1)];
  pal = lvlData.palette;
  
  // Add house
  obs.push({t:'house',a:true,x:260,y:20,w:110,h:90});
  
  // Create tiles
  const ts = 20;
  for(let r = 0; r < 15; r++) {
    for(let c = 0; c < 20; c++) {
      const x = c * ts, y = r * ts;
      if(r < 3 && c < 3) continue;
      const tile = {x,y,w:ts,h:ts,m:false};
      if(!hit(tile, {x:260,y:20,w:110,h:90})) {
        tiles.push(tile);
      }
    }
  }
  
  // Add obstacles
  const obstacleTypes = ['rock','tree','sprinkler','gnome','flamingo','grill','chair'];
  const numObs = 4 + Math.min(level, 4);
  
  for(let i = 0; i < numObs; i++) {
    const type = rc(obstacleTypes);
    for(let tries = 0; tries < 20; tries++) {
      const o = {
        t: type,
        a: true,
        x: ri(40, BASE_W - 60),
        y: ri(50, BASE_H - 60),
        w: 26,
        h: 26
      };
      
      const safe = !hit(o, {x:0,y:0,w:100,h:100}) && 
                   !hit(o, {x:260,y:20,w:110,h:90}) &&
                   !obs.some(existing => hit(o, existing));
      
      if(safe) {
        obs.push(o);
        tiles = tiles.filter(t => !hit(t, o));
        break;
      }
    }
  }
  
  // Add power-ups
  if(Math.random() < 0.5) {
    powerUps.push({t:'golf',x:ri(60,BASE_W-60),y:ri(70,BASE_H-80),w:24,h:24,a:true,tt:18});
  }
  if(Math.random() < 0.4) {
    powerUps.push({t:'leaf',x:ri(60,BASE_W-60),y:ri(70,BASE_H-80),w:24,h:24,a:true,tt:18});
  }
  
  spawnBud();
  gameState.timers.bud = setInterval(spawnBud, 10000);
  
  gameState.limit = Math.round(70 + 25/Math.sqrt(level));
  
  document.getElementById('levelName').textContent = lvlData.n;
  document.getElementById('levelDesc').textContent = lvlData.d;
  updateWeatherDisplay();
  
  const bar = document.getElementById('bar');
  bar.style.width = '0%';
  bar.textContent = 'üåø 0% Mowed';
  
  const startBtn = document.getElementById('startLevelBtn');
  startBtn.textContent = 'Start: ' + lvlData.n;
  startBtn.disabled = false;
  
  document.getElementById('pauseBtn').disabled = true;
  document.getElementById('shareShot').style.display = 'none';
  
  draw();
}

/* -------------------- Sprites -------------------- */
const spriteSvgs = {
  house: `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><path d='M8 28 L32 8 L56 28 Z' fill='#b5651d'/><rect x='14' y='28' width='36' height='28' rx='3' fill='#d9d9d9' stroke='#555'/><rect x='28' y='40' width='10' height='16' fill='#9ecae1'/></svg>`,
  rock: `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><ellipse cx='32' cy='40' rx='22' ry='14' fill='#777'/><ellipse cx='28' cy='34' rx='10' ry='6' fill='#888'/></svg>`,
  tree: `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><rect x='28' y='34' width='8' height='18' fill='#8b5a2b'/><circle cx='32' cy='28' r='18' fill='#2e7d32'/></svg>`,
  sprinkler: `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><rect x='28' y='44' width='8' height='8' fill='#444'/><path d='M16 40 Q32 24 48 40' stroke='#4fc3f7' stroke-width='4' fill='none'/></svg>`,
  gnome: `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><path d='M32 8 L44 24 H20 Z' fill='#e53935'/><circle cx='32' cy='30' r='8' fill='#ffe0b2'/><rect x='20' y='38' width='24' height='16' fill='#1976d2'/></svg>`,
  flamingo: `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><circle cx='24' cy='28' r='10' fill='#ff6ea2'/><rect x='22' y='38' width='4' height='16' fill='#ff6ea2'/><rect x='34' y='24' width='16' height='8' rx='4' fill='#ff6ea2'/></svg>`,
  grill: `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><ellipse cx='32' cy='28' rx='18' ry='12' fill='#222'/><rect x='14' y='28' width='36' height='6' fill='#333'/><rect x='30' y='34' width='4' height='16' fill='#222'/></svg>`,
  chair: `<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><rect x='18' y='22' width='28' height='8' fill='#90caf9'/><rect x='18' y='30' width='28' height='12' fill='#e3f2fd'/><rect x='20' y='42' width='4' height='12' fill='#90caf9'/><rect x='42' y='42' width='4' height='12' fill='#90caf9'/></svg>`
};
const sprites = {};
function makeImage(svg){ const img = new Image(); img.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg); return img; }
function buildSprites(){ for(const [k,svg] of Object.entries(spriteSvgs)){ sprites[k] = makeImage(svg); } }
function drawSprite(type,x,y,w,h){ const img = sprites[type]; if(img && img.complete){ ctx.drawImage(img,x,y,w,h); return true; } return false; }

/* -------------------- Drawing -------------------- */
function draw() {
  if(!pal) return;
  
  ctx.fillStyle = pal.skyColor;
  ctx.fillRect(0, 0, BASE_W, BASE_H);
  
  // Draw grass tiles
  for(const t of tiles) {
    ctx.fillStyle = t.m ? pal.mowedColor : pal.grassColor;
    ctx.fillRect(t.x, t.y, t.w, t.h);
    
    // Tile border
    ctx.strokeStyle = 'rgba(0,0,0,0.1)';
    ctx.lineWidth = 1;
    ctx.strokeRect(t.x, t.y, t.w, t.h);
  }
  
  // Draw obstacles
  for(const o of obs) {
    if(!o.a) continue;
    const drew = drawSprite(o.t, o.x, o.y, o.w, o.h);
    if(!drew){
      ctx.fillStyle = '#666';
      ctx.fillRect(o.x, o.y, o.w, o.h);
      ctx.fillStyle = '#fff';
      ctx.font = '12px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      const labels = { house:'H', rock:'R', tree:'T', sprinkler:'S', gnome:'G', flamingo:'F', grill:'B', chair:'C' };
      ctx.fillText(labels[o.t] || '?', o.x + o.w/2, o.y + o.h/2);
    }
  }
  
  // Draw power-ups
  for(const p of powerUps) {
    if(!p.a) continue;

    ctx.save();
    ctx.translate(p.x + p.w/2, p.y + p.h/2);
    ctx.rotate((Date.now() / 500) % (Math.PI * 2));
    ctx.font = `${p.w}px serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    const emojis = {bud:'üç∫',golf:'üöó',leaf:'üçÉ'};
    ctx.fillText(emojis[p.t] || '‚ùì', 0, 0);
    ctx.restore();
  }
  
  // Draw particles
  for(const p of particles) {
    ctx.fillStyle = `rgba(0,128,0,${p.life})`;
    const size = 3 * p.life;
    ctx.fillRect(p.x, p.y, size, size);
  }
  
  // Draw mower
  drawMower();
  
  // Weather effects
  if(weather.type === 'rain') {
    ctx.fillStyle = 'rgba(0,0,255,0.08)';
    ctx.fillRect(0, 0, BASE_W, BASE_H);
    
    for(let i = 0; i < 10; i++) {
      const x = (Date.now() / 10 + i * 50) % BASE_W;
      const y = (Date.now() / 5 + i * 30) % BASE_H;
      ctx.fillStyle = 'rgba(173,216,230,0.7)';
      ctx.fillRect(x, y, 2, 8);
    }
  } else if(weather.type === 'wind') {
    ctx.fillStyle = 'rgba(200,200,200,0.08)';
    ctx.fillRect(0, 0, BASE_W, BASE_H);
  }
}

function drawMower() {
  const m = mower;

  ctx.font = `${m.h}px serif`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('üöú', m.x + m.w/2, m.y + m.h/2);

  // Power-up indicators
  if(m.boost) {
    ctx.strokeStyle = '#2E7D32';
    ctx.lineWidth = 3;
    ctx.strokeRect(m.x - 2, m.y - 2, m.w + 4, m.h + 4);
  }

  if(m.inv) {
    ctx.strokeStyle = '#FFD700';
    ctx.lineWidth = 2;
    ctx.setLineDash([5, 5]);
    ctx.strokeRect(m.x - 3, m.y - 3, m.w + 6, m.h + 6);
    ctx.setLineDash([]);
  }
}

/* -------------------- Power-ups -------------------- */
function applyPowerUp(type) {
  if(type === 'bud') {
    counts.bud++;
    mower.spd = Math.min(220, mower.spd * 1.5);
    mower.boost = true;
    gameState.score += 100;
    setComment("Bud boost activated!");
    showToast("Speed Boost!");
    beep(880, .05, .15);
    
    clearTimeout(gameState.timers.budBoost);
    gameState.timers.budBoost = setTimeout(() => {
      mower.spd = 120;
      mower.boost = false;
    }, 5000);
    
  } else if(type === 'golf') {
    counts.golf++;
    gameState.score += 500;
    mower.inv = true;
    setComment("Golf cart mode - invincible!");
    chime();
    
    clearTimeout(gameState.timers.golfInv);
    gameState.timers.golfInv = setTimeout(() => {
      mower.inv = false;
    }, 3200);
    
  } else if(type === 'leaf') {
    counts.leaf++;
    gameState.score += 200;
    obs = obs.filter(o => o.t !== 'rock');
    setComment("Leaf blower cleared the rocks!");
    beep(520, .05, .12);
  }
  
  updateCounts();
}

function updateCounts() {
  document.getElementById('budCount').textContent = counts.bud;
  document.getElementById('golfCount').textContent = counts.golf;
  document.getElementById('leafCount').textContent = counts.leaf;
}

/* -------------------- UI Functions -------------------- */
function setComment(text) {
  const comment = document.getElementById('comment');
  clearTimeout(gameState.timers.comment);
  comment.textContent = text;
  
  gameState.timers.comment = setTimeout(() => {
    comment.textContent = rc([
      "Keep mowing! The HOA is watching.",
      "Perfect stripes make perfect neighbors.",
      "Barefoot precision at its finest.",
      "Charlie would be proud."
    ]);
  }, 3000);
}

function updateUI() {
  document.getElementById('hudLevel').textContent = gameState.lvl;
  document.getElementById('hudScore').textContent = gameState.score;
  document.getElementById('timer').textContent = fmt(gameState.total);
  document.getElementById('levelTimer').textContent = fmt(gameState.total - gameState.lvlStart);
}

function updateWeatherDisplay() {
  const weatherEl = document.getElementById('weatherEl');
  weatherEl.textContent = 
    weather.type === 'sun' ? '‚òÄÔ∏è Perfect' :
    weather.type === 'rain' ? 'üåßÔ∏è Rainy' : 'üí® Windy';
}

function showOverlay(el) {
  el.style.display = 'block';
  el.classList.remove('hide');
  void el.offsetWidth;
  el.classList.add('show');
}

function hideOverlay(el) {
  el.classList.remove('show');
  el.classList.add('hide');
  setTimeout(() => {
    el.style.display = 'none';
    el.classList.remove('hide');
  }, 200);
}

/* -------------------- Game Flow -------------------- */
function startGame() {
  const playerName = document.getElementById('playerName');
  const entered = (playerName.value || "").trim();
  
  if(!entered) {
    showToast('Please enter your name');
    playerName.focus();
    return;
  }
  
  initAudio();
  
  gameState.name = entered;
  gameState.score = 0;
  gameState.total = 0;
  gameState.lvl = 1;
  counts.bud = counts.golf = counts.leaf = 0;
  updateCounts();
  
  localStorage.setItem('clmc_name', gameState.name);
  
  document.getElementById('landing').style.display = 'none';
  document.body.classList.add('playing');
  document.getElementById('game').style.display = 'block';
  fitCanvas();
  document.getElementById('hudName').textContent = gameState.name;
  document.getElementById('hudBest').textContent = localStorage.getItem('clmc_best') || 0;
  
  setup(gameState.lvl);
  updateUI();
  showIntro();
  setComment("Welcome to the championship!");
}

function showIntro() {
  const intro = document.getElementById('ovIntro');
  const lvlData = levels[Math.min(gameState.lvl - 1, levels.length - 1)];
  
  document.getElementById('introTitle').textContent = `Level ${gameState.lvl}: ${lvlData.n}`;
  document.getElementById('introDesc').textContent = lvlData.d;
  document.getElementById('introBody').textContent = 
    introsByLevel[Math.min(gameState.lvl - 1, introsByLevel.length - 1)][0];
  
  showOverlay(intro);
  gameState.introShown = true;
}

function startLevel() {
  if(gameState.running) return;
  
  hideOverlay(document.getElementById('ovIntro'));
  
  gameState.running = true;
  gameState.paused = false;
  gameState.lvlStart = gameState.total;
  
  document.getElementById('startLevelBtn').disabled = true;
  document.getElementById('pauseBtn').disabled = false;
  
  gameState.last = performance.now();
  gameState.loop = requestAnimationFrame(frame);
}

function levelComplete() {
  gameState.running = false;
  cancelAnimationFrame(gameState.loop);
  cleanupTimers();
  
  const lt = gameState.total - gameState.lvlStart;
  const bonus = Math.round(Math.max(0, (gameState.limit - lt) * 50));
  gameState.score = Math.round((gameState.score + bonus) / 10) * 10;
  
  const ovComplete = document.getElementById('ovComplete');
  document.getElementById('ovTime').textContent = fmt(lt);
  document.getElementById('ovScore').textContent = gameState.score;
  document.getElementById('ovBonus').textContent = bonus;
  
  const congrats = congratsByLevel[Math.min(gameState.lvl - 1, congratsByLevel.length - 1)][0];
  document.getElementById('ovCongrats').textContent = congrats.replace('{n}', gameState.name);
  
  showOverlay(ovComplete);
  chime();
  
  saveScore();
  document.getElementById('shareShot').style.display = 'inline-block';
}

function nextLevel() {
  hideOverlay(document.getElementById('ovComplete'));
  gameState.lvl++;
  
  if(gameState.lvl > 12) {
    finale();
  } else {
    setup(gameState.lvl);
    updateUI();
    showIntro();
  }
}

function gameOver(reason = 'time') {
  gameState.running = false;
  cancelAnimationFrame(gameState.loop);
  cleanupTimers();
  
  const ovGameOver = document.getElementById('ovGameOver');
  
  if(reason === 'obstacle') {
    document.getElementById('ovGameOverTitle').textContent = 'Crash! üí•';
    document.getElementById('ovReason').textContent = 'You hit an obstacle on';
    ovGameOver.classList.add('crash');
  } else {
    document.getElementById('ovGameOverTitle').textContent = "Time's Up! ‚è∞";
    document.getElementById('ovReason').textContent = 'You ran out of time on';
    ovGameOver.classList.remove('crash');
  }
  
  document.getElementById('ovFailed').textContent = gameState.lvl;
  document.getElementById('ovFinalScore').textContent = gameState.score;
  
  showOverlay(ovGameOver);
  beep(200, .1, .2);
  
  saveScore();
}

function finale() {
  cleanupTimers();
  
  const ovFinal = document.getElementById('ovFinalOverlay');
  document.getElementById('ovWinner').textContent = gameState.name;
  document.getElementById('ovTotal').textContent = fmt(gameState.total);
  document.getElementById('ovChamp').textContent = gameState.score;
  
  showOverlay(ovFinal);
  chime();
  setTimeout(chime, 100);
  
  const best = Math.max(gameState.score, parseInt(localStorage.getItem('clmc_best') || '0', 10));
  localStorage.setItem('clmc_best', best);
  
  saveScore();
}

function restart() {
  cleanupTimers();
  resetInputState();
  
  gameState.running = false;
  gameState.paused = false;
  cancelAnimationFrame(gameState.loop);
  
  document.getElementById('game').style.display = 'none';
  document.getElementById('landing').style.display = 'flex';
  
  ['ovGameOver','ovFinalOverlay','ovComplete','ovLB','ovPause','ovChallenge','ovIntro'].forEach(id => {
    hideOverlay(document.getElementById(id));
  });
  
  counts.bud = counts.golf = counts.leaf = 0;
  updateCounts();
  
  loadLeaderboard();
}

function togglePause() {
  if(!gameState.running) return;
  
  gameState.paused = !gameState.paused;
  document.getElementById('pauseBtn').textContent = gameState.paused ? 'Resume' : 'Pause';
  
  if(gameState.paused) {
    showOverlay(document.getElementById('ovPause'));
  } else {
    hideOverlay(document.getElementById('ovPause'));
    gameState.last = performance.now();
    gameState.loop = requestAnimationFrame(frame);
  }
}

/* -------------------- Leaderboard -------------------- */
function saveScore() {
  const runs = loadRuns();
  runs.push({
    n: gameState.name,
    s: gameState.score,
    t: gameState.total,
    l: gameState.lvl,
    ts: Date.now()
  });
  
  runs.sort((a, b) => b.s - a.s || a.t - b.t);
  localStorage.setItem('clmc_runs_v1', JSON.stringify(runs.slice(0, 200)));
  
  loadLeaderboard();
}

function loadRuns() {
  try {
    return JSON.parse(localStorage.getItem('clmc_runs_v1') || '[]');
  } catch {
    return [];
  }
}

function loadLeaderboard() {
  const runs = loadRuns();
  const preview = document.getElementById('leaderboardPreview');
  
  if(runs.length) {
    preview.innerHTML = runs.slice(0, 3).map((r, i) => 
      `${i + 1}. ${escapeHTML(r.n)} ‚Äî ${r.s} pts ‚Äî ${fmt(r.t)}`
    ).join('<br/>');
  } else {
    preview.innerHTML = "Be the first champion! üå±";
  }
}

function week(ts) {
  const now = new Date();
  const start = new Date(now);
  start.setHours(0, 0, 0, 0);
  const day = start.getDay();
  const diff = (day + 6) % 7;
  start.setDate(start.getDate() - diff);
  const end = new Date(start);
  end.setDate(start.getDate() + 7);
  return ts >= start.getTime() && ts < end.getTime();
}

function showLeaderboard(filter = 'all') {
  const runs = loadRuns();
  let list = runs;

  if(filter === 'week') {
    list = runs.filter(r => week(r.ts));
  } else if(filter === 'you') {
    list = runs.filter(r => r.n === gameState.name);
  }
  
  const lbList = document.getElementById('lbList');
  lbList.innerHTML = list.length ? 
    list.slice(0, 30).map((r, i) => 
      `${i + 1}. ${escapeHTML(r.n)} - ${r.s} pts - ${fmt(r.t)}`
    ).join('<br/>') : 
    "No entries yet.";
  
  showOverlay(document.getElementById('ovLB'));
}

function escapeHTML(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

/* -------------------- Event Bindings -------------------- */
const startForm = document.getElementById('startForm');
startForm.addEventListener('submit', e => {
  e.preventDefault();
  startGame();
});

document.getElementById('startLevelBtn').addEventListener('click', () => {
  if(!gameState.introShown) {
    showIntro();
  } else {
    startLevel();
  }
});

document.getElementById('introGo').addEventListener('click', startLevel);
document.getElementById('pauseBtn').addEventListener('click', togglePause);
document.getElementById('resume').addEventListener('click', togglePause);
document.getElementById('nextLevel').addEventListener('click', nextLevel);
document.getElementById('restart').addEventListener('click', restart);
document.getElementById('again').addEventListener('click', restart);
document.getElementById('showLB').addEventListener('click', () => {
  hideOverlay(document.getElementById('ovGameOver'));
  showLeaderboard('all');
});
document.getElementById('goLB').addEventListener('click', () => showLeaderboard('all'));
document.getElementById('lbBack').addEventListener('click', () => {
  hideOverlay(document.getElementById('ovLB'));
});

// Leaderboard filters
document.getElementById('fAll').addEventListener('click', () => {
  document.querySelectorAll('.filter').forEach(f => f.classList.remove('active'));
  document.getElementById('fAll').classList.add('active');
  showLeaderboard('all');
});

document.getElementById('fWeek').addEventListener('click', () => {
  document.querySelectorAll('.filter').forEach(f => f.classList.remove('active'));
  document.getElementById('fWeek').classList.add('active');
  showLeaderboard('week');
});

document.getElementById('fYou').addEventListener('click', () => {
  document.querySelectorAll('.filter').forEach(f => f.classList.remove('active'));
  document.getElementById('fYou').classList.add('active');
  showLeaderboard('you');
});

// Challenge & Share
document.getElementById('challengeBtn').addEventListener('click', () => {
  const msg = `I scored ${gameState.score} in Charlie's Lawn Mowing Adventure. Beat me: ${location.href}`;
  const ch = document.getElementById('chText');
  ch.value = msg;
  showOverlay(document.getElementById('ovChallenge'));
});

document.getElementById('copyCh').addEventListener('click', async () => {
  const txt = document.getElementById('chText').value;
  try { await navigator.clipboard.writeText(txt); showToast('Copied'); }
  catch { 
    const ta = document.getElementById('chText');
    ta.focus();
    ta.select();
    document.execCommand('copy');
    showToast('Copied');
  }
});

document.getElementById('closeCh').addEventListener('click', () => hideOverlay(document.getElementById('ovChallenge')));

document.getElementById('shareGameBtn').addEventListener('click', async () => {
  const text = `Come mow. My best is ${localStorage.getItem('clmc_best') || 0}.`;
  const url = location.href;
  if(navigator.share){
    try{ await navigator.share({title:"Charlie's Lawn Mowing Adventure", text, url}); }
    catch(e){}
  } else {
    const ch = document.getElementById('chText');
    ch.value = `${text} ${url}`;
    showOverlay(document.getElementById('ovChallenge'));
  }
});

document.getElementById('shareShot').addEventListener('click', () => {
  try{
     const link = document.createElement('a');
     link.href = cvs.toDataURL('image/png');
     link.download = `charlie_${Date.now()}.png`;
     document.body.appendChild(link);
     link.click();
     link.remove();
     showToast('Screenshot saved');
  } catch(e) { showToast('Screenshot not supported'); }
});

// Sound toggle
document.getElementById('soundBtn').addEventListener('click', () => {
  snd = !snd;
  if(snd) initAudio();
  const btn = document.getElementById('soundBtn');
  btn.textContent = snd ? 'üîä' : 'üîá';
  btn.setAttribute('aria-pressed', snd ? 'true' : 'false');
});

// Window events
window.addEventListener('resize', fitCanvas);

document.addEventListener('visibilitychange', () => {
  if(document.hidden && gameState.running && !gameState.paused){
    togglePause();
  }
});

// initial boot
(function init(){
  fitCanvas();
  buildSprites();

  loadLeaderboard();
  const stored = localStorage.getItem('clmc_name');
  if(stored) document.getElementById('playerName').value = stored;
})();
</script>
</body>
</html>
